#!/usr/bin/perl

use strict;
use warnings;
use PDL;

use Test::More;

BEGIN
{
  plan tests => 5;
  use_ok( 'PDL::FFTW3' );
}

use constant approx_eps => 1e-3;


{
  my $x = sequence(10)->cat(sequence(10)**2)->mv(-1,0);

  # from octave: conj( fft( (0:9) + i* ((0:9).**2) )' )
  my $Xref = pdl( [  45.000, +285.000],
                  [-158.884, + 17.749],
                  [ -73.819, - 28.646],
                  [ -41.327, - 38.728],
                  [ -21.246, - 42.848],
                  [  -5.000, - 45.000],
                  [  11.246, - 46.097],
                  [  31.327, - 45.993],
                  [  63.819, - 42.410],
                  [ 148.884, - 13.028] );


  ok(all( approx( fft1($x), $Xref, approx_eps) ),
     "Basic 1D complex FFT - double precision" );

  ok(all( approx( fft1(float $x), float($Xref), approx_eps) ),
     "Basic 1D complex FFT - single precision" );
}

{
  my $x = sequence(5,7)->cat(1e-2 * sequence(5,7)**2)->mv(-1,0);

  # from octave: fft2( reshape(0:34,5,7)' + i* (1e-2*reshape(0:34,5,7)' .** 2) )
  my $Xref =
    pdl( [ [5.95000000000000e+02, + 1.36850000000000e+02],   [-2.59303392628859e+01, + 1.84682083666705e+01],   [-1.94901331394265e+01, - 2.45430074349120e-01],   [-1.55098668605735e+01, - 1.16176194425008e+01],   [-9.06966073711407e+00, - 2.97051588498206e+01]],
         [[-1.58361292658031e+02, + 1.70810364558179e+02],    [3.02129040241307e+00, - 1.62582569424951e+00],    [2.10126095620458e+00, + 2.84635136279005e-01],    [1.53265148779700e+00, + 1.46536486372099e+00],    [6.12622041588519e-01, + 3.37582569424951e+00]],
         [[-1.14713779395612e+02, + 4.28112631783535e+01],    [1.90212339568438e+00, - 8.54244602002882e-02],    [9.82093949475899e-01, + 6.48274540139187e-01],    [4.13484481068306e-01, + 1.10172545986082e+00],   [-5.06544965140175e-01, + 1.83542446020029e+00]],
         [[-9.52888085635639e+01, - 9.55078000010450e+00],    [1.40404722050367e+00, + 6.00118582335890e-01],    [4.84017774295172e-01, + 8.10109299679749e-01],   [-8.45916941124162e-02, + 9.39890700320246e-01],   [-1.00462114032089e+00, + 1.14988141766411e+00]],
         [[-7.97111914364361e+01, - 4.94933880183808e+01],    [1.00462114032090e+00, + 1.14988141766412e+00],    [8.45916941124141e-02, + 9.39890700320234e-01],   [-4.84017774295178e-01, + 8.10109299679762e-01],   [-1.40404722050366e+00, + 6.00118582335895e-01]],
         [[-6.02862206043880e+01, - 9.67465798760672e+01],    [5.06544965140170e-01, + 1.83542446020029e+00],   [-4.13484481068314e-01, + 1.10172545986081e+00],   [-9.82093949475905e-01, + 6.48274540139193e-01],   [-1.90212339568438e+00, - 8.54244602002870e-02]],
         [[-1.66387073419690e+01, - 1.92580879841980e+02],   [-6.12622041588522e-01, + 3.37582569424950e+00],   [-1.53265148779701e+00, + 1.46536486372098e+00],   [-2.10126095620459e+00, + 2.84635136279020e-01],   [-3.02129040241307e+00, - 1.62582569424950e+00]] );


  ok(all( approx( fft2($x), $Xref, approx_eps) ),
     "Basic 2D complex FFT - double precision" );

  ok(all( approx( fft2(float $x), float($Xref), approx_eps) ),
     "Basic 2D complex FFT - single precision" );
}
